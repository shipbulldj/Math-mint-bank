<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MathMint Quiz | Learn × Earn × Mint on Mezo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0F0F1A, #1A1A2E); color: white; }
    .btn { @apply px-4 py-2 rounded-lg font-bold transition-all; }
    .btn-blue { @apply bg-blue-600 hover:bg-blue-700 text-white; }
    .btn-green { @apply bg-green-500 hover:bg-green-600 text-white; }
    .btn-orange { @apply bg-orange-500 hover:bg-orange-600 text-white; }
    .timer-bar { height: 6px; transition: width 0.1s linear; }
    .correct { @apply text-green-400 animate-pulse; }
    .wrong { @apply text-red-400 animate-pulse; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">

  <div class="max-w-2xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-2">MathMint Quiz</h1>
      <p class="text-lg opacity-90">Learn Times Tables → Mint NFT Badges</p>
      <p class="text-sm mt-2">Built on <span class="text-blue-400">Mezo</span> — Bitcoin's Fastest L2</p>
    </div>

    <!-- Play Quiz (No Wallet) -->
    <div id="quiz-section" class="bg-white text-gray-900 rounded-xl p-6 shadow-xl">
      <h2 class="text-2xl font-bold text-center mb-4">Play Quiz (No Wallet Required!)</h2>
      <p class="text-center mb-4">Answer 5 times-table questions and rack up points!</p>
      <ul class="text-sm space-y-1 mb-4 text-center">
        <li>Correct answer: +10 points</li>
        <li>Wrong answer: -1 point</li>
        <li>15 seconds per question</li>
      </ul>

      <div id="quiz-ui" class="hidden">
        <div class="text-center mb-4">
          <p class="text-lg font-bold" id="question"></p>
          <div class="timer-bar bg-green-500 w-full mt-2" id="timer"></div>
        </div>
        <div class="grid grid-cols-2 gap-3" id="options"></div>
        <p class="text-center mt-4 text-sm" id="feedback"></p>
      </div>

      <div class="text-center">
        <button id="start-quiz" class="btn btn-green text-lg">Start Quiz</button>
        <p id="score-display" class="mt-4 text-lg font-bold hidden">Score: <span id="current-score">0</span></p>
      </div>
    </div>

    <!-- Wallet & Save Score -->
    <div id="wallet-section" class="mt-6 bg-gradient-to-br from-blue-900 to-purple-900 p-6 rounded-xl shadow-xl">
      <h3 class="text-xl font-bold mb-3">Save Your Score Forever?</h3>
      <p class="text-sm mb-3">Connect your wallet below! (It's free!)</p>

      <div class="flex flex-col gap-3">
        <button id="connect-metamask" class="btn btn-blue">Connect with MetaMask</button>
        <button id="connect-bitcoin" class="btn btn-orange text-sm">Connect Unisat / Leather (Bitcoin)</button>
      </div>

      <p id="wallet-status" class="mt-3 text-sm font-mono">Not Connected</p>

      <!-- MUSD Boost -->
      <div class="mt-4 p-3 bg-black bg-opacity-30 rounded-lg">
        <div class="flex items-center gap-2">
          <input type="checkbox" id="musd-boost" class="w-5 h-5" disabled>
          <label for="musd-boost" class="text-sm">Secret Bonus: Hold 1+ MUSD → 1.5x points!</label>
        </div>
        <div class="mt-2 text-xs">
          <a href="https://testnet.mezo.org/" target="_blank" class="text-green-400 hover:underline">
            Need MUSD? Swap tBTC here (connect → DEX)
          </a>
        </div>
      </div>

      <!-- Faucet -->
      <div class="mt-3 text-xs">
        <a href="https://faucet.test.mezo.org/" target="_blank" class="text-cyan-400 hover:underline" title="Get free tBTC for gas">
          Free Practice Money: Grab tBTC here
        </a>
      </div>
    </div>

    <!-- Mint NFT -->
    <div id="mint-section" class="mt-6 bg-gradient-to-r from-pink-600 to-purple-600 p-6 rounded-xl shadow-xl hidden">
      <h3 class="text-xl font-bold mb-3">Mint Your Badge</h3>
      <p class="text-sm mb-3">Get 50+ points total and mint your achievement badge!</p>
      <button id="mint-nft" class="btn btn-green w-full" disabled>Mint NFT (Need 50+ pts)</button>
      <p id="mint-status" class="mt-3 text-sm"></p>
    </div>

    <!-- Leaderboard -->
    <div class="mt-6 p-4 bg-white text-gray-900 rounded-xl shadow-xl">
      <h3 class="text-lg font-bold text-center mb-3">Top Players</h3>
      <div id="leaderboard-list" class="max-h-48 overflow-y-auto space-y-1 text-sm">
        <p class="text-center text-gray-500">Loading...</p>
      </div>
    </div>

    <!-- Contract Addresses -->
    <div class="mt-6 text-xs text-center opacity-70">
      <p>Quiz: <span class="font-mono">0x59bDB59...DD7d30f</span></p>
      <p>NFT: <span class="font-mono">0x03672f6...CE531f0</span></p>
      <p>MUSD: <span class="font-mono">0x118917a...973Ac503</span></p>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // === CONFIG ===
    const MEZO_TESTNET = {
      chainId: '0x1F4B', // Mezo Testnet
      chainName: 'Mezo Testnet',
      rpcUrls: ['https://rpc.testnet.mezo.org'],
      nativeCurrency: { name: 'tBTC', symbol: 'tBTC', decimals: 18 },
      blockExplorerUrls: ['https://testnet.mezo.org']
    };
    const QUIZ_CONTRACT = '0x59bDB59bD7f7e7dD7d30f'; // Replace with real
    const NFT_CONTRACT = '0x03672f6CE531f0';
    const MUSD_ADDRESS = '0x118917a973Ac503';

    // === STATE ===
    let web3, account, provider, multiplier = 1;
    let score = 0, questionIndex = 0, timer;
    const questions = [];

    // === DOM ===
    const startBtn = document.getElementById('start-quiz');
    const quizUI = document.getElementById('quiz-ui');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const feedbackEl = document.getElementById('feedback');
    const timerEl = document.getElementById('timer');
    const scoreDisplay = document.getElementById('score-display');
    const currentScoreEl = document.getElementById('current-score');
    const connectMetaMask = document.getElementById('connect-metamask');
    const connectBitcoin = document.getElementById('connect-bitcoin');
    const walletStatus = document.getElementById('wallet-status');
    const musdBoost = document.getElementById('musd-boost');
    const mintBtn = document.getElementById('mint-nft');
    const mintStatus = document.getElementById('mint-status');
    const leaderboardList = document.getElementById('leaderboard-list');

    // === QUIZ LOGIC ===
    function generateQuestions() {
      questions.length = 0;
      for (let i = 0; i < 5; i++) {
        const a = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 10) + 1;
        questions.push({ a, b, answer: a * b, options: shuffle([a*b, a*b+1, a*b-1, a*b+2]) });
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startQuiz() {
      score = 0;
      questionIndex = 0;
      generateQuestions();
      startBtn.classList.add('hidden');
      quizUI.classList.remove('hidden');
      scoreDisplay.classList.remove('hidden');
      currentScoreEl.textContent = score;
      showQuestion();
    }

    function showQuestion() {
      if (questionIndex >= 5) return endQuiz();
      const q = questions[questionIndex];
      questionEl.textContent = `${q.a} × ${q.b} = ?`;
      optionsEl.innerHTML = '';
      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-blue text-lg';
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt, q.answer);
        optionsEl.appendChild(btn);
      });
      startTimer();
    }

    function startTimer() {
      let time = 15;
      timerEl.style.width = '100%';
      timer = setInterval(() => {
        time--;
        timerEl.style.width = `${(time / 15) * 100}%`;
        if (time <= 0) {
          clearInterval(timer);
          checkAnswer(null, questions[questionIndex].answer);
        }
      }, 1000);
    }

    function checkAnswer(selected, correct) {
      clearInterval(timer);
      const points = selected === correct ? 10 * multiplier : -1;
      score += points;
      currentScoreEl.textContent = score;
      feedbackEl.className = selected === correct ? 'correct' : 'wrong';
      feedbackEl.textContent = selected === correct ? `Correct! +${10 * multiplier}` : 'Wrong! -1';
      setTimeout(() => {
        feedbackEl.textContent = '';
        questionIndex++;
        if (questionIndex < 5) showQuestion();
        else endQuiz();
      }, 1000);
    }

    function endQuiz() {
      quizUI.classList.add('hidden');
      startBtn.classList.remove('hidden');
      startBtn.textContent = 'Play Again';
      if (account) saveScore();
      updateMintButton();
    }

    // === WEB3 ===
    async function connectMetaMaskWallet() {
      if (!window.ethereum) return alert('Install MetaMask!');
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        web3 = new Web3(window.ethereum);
        const chainId = await web3.eth.getChainId();
        if (chainId !== parseInt(MEZO_TESTNET.chainId)) {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: MEZO_TESTNET.chainId }],
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [MEZO_TESTNET],
              });
            }
          }
        }
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        provider = window.ethereum;
        onConnect();
      } catch (err) { alert('Connection rejected'); }
    }

    async function connectBitcoinWallet() {
      const unisat = window.unisat || window.leather;
      if (!unisat) return alert('Install Unisat or Leather wallet!');
      try {
        const accounts = await unisat.requestAccounts();
        account = accounts[0];
        provider = unisat;
        web3 = new Web3(new Web3.providers.HttpProvider('https://rpc.testnet.mezo.org'));
        onConnect();
      } catch (err) { alert('Bitcoin wallet rejected'); }
    }

    function onConnect() {
      walletStatus.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
      walletStatus.className = 'text-green-400 font-mono';
      musdBoost.disabled = false;
      connectMetaMask.disabled = true;
      connectBitcoin.disabled = true;
      loadLeaderboard();
      updateMintButton();
    }

    async function saveScore() {
      // Simulate on-chain save
      console.log('Saving score:', score, 'for', account);
    }

    async function mintNFT() {
      mintStatus.textContent = 'Minting...';
      setTimeout(() => {
        mintStatus.innerHTML = 'NFT Minted! Check your wallet!';
        mintBtn.disabled = true;
        loadLeaderboard();
      }, 2000);
    }

    function updateMintButton() {
      if (score >= 50 && account) {
        mintBtn.disabled = false;
        mintBtn.textContent = `Mint NFT (${score} pts)`;
        document.getElementById('mint-section').classList.remove('hidden');
      }
    }

    async function loadLeaderboard() {
      leaderboardList.innerHTML = `
        <div class="flex justify-between px-2 py-1 bg-gray-100"><span>#1 shipbulldj</span><span>60 pts</span></div>
        <div class="flex justify-between px-2 py-1"><span>#2 0x1234...</span><span>55 pts</span></div>
        <div class="flex justify-between px-2 py-1 bg-gray-100"><span>#3 anon</span><span>50 pts</span></div>
      `;
    }

    // === EVENTS ===
    startBtn.onclick = startQuiz;
    connectMetaMask.onclick = connectMetaMaskWallet;
    connectBitcoin.onclick = connectBitcoinWallet;
    mintBtn.onclick = mintNFT;
    musdBoost.onchange = () => { multiplier = musdBoost.checked ? 1.5 : 1; };

    // Init
    loadLeaderboard();
  </script>
</body>
</html>
